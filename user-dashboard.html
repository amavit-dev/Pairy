<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Au Pair User Dashboard - Connect with other au pairs">
  <title>User Dashboard - Pairy</title>
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="./css/main.css">
  <link rel="stylesheet" href="./css/forum.css">
  <link rel="stylesheet" href="./css/chat.css">

    <style>
      .nav-item {
        padding: 12px 15px;
        margin: 5px 10px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
        background: white;
        border: 2px solid transparent;
        position: relative;
      }
      
      .nav-item:hover {
        background: #FFF5F7;
        border-color: #FFD1DC;
      }
      
      .nav-item.active {
        background: #FFD1DC;
        border-color: #FFB6C1;
      }
      
      .nav-icon {
        font-size: 1.25rem;
      }
      
      .nav-label {
        font-weight: 600;
        color: #333;
        flex: 1;
      }
      
      .nav-item .unread-badge {
        background: #FFB6C1;
        color: white;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.75rem;
        font-weight: 600;
        min-width: 20px;
        text-align: center;
      }
      
      #forumCategoriesNav {
        margin-top: 10px;
      }
    </style>
  </head>
<body>
  <!-- Mobile Menu Toggle -->
  <button
class="mobile-menu-toggle"
id="mobileMenuToggle"
aria-label="Toggle menu"
>
    ‚ò∞
  </button>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

  <!-- Dashboard Layout -->
  <div class="dashboard-layout">
    <!-- Sidebar Navigation -->
    <aside class="forum-sidebar" id="forumSidebar">
      <div class="sidebar-header">
        <img
src="./images/logo.png"
alt="Pairy Logo"
class="sidebar-logo"
>
        <h2>Pairy</h2>
        <p>Community Forum</p>
      </div>

      <div class="user-profile-sidebar">
        <div class="user-avatar" id="sidebarAvatar">U</div>
        <div class="user-info-sidebar">
          <h3 id="sidebarUserName">User</h3>
          <p id="sidebarUsername">@username</p>
        </div>
      </div>

      <nav class="category-nav">
        <h3>Navigation</h3>
        <div class="nav-item" onclick="showForumView()" id="navForum">
          <span class="nav-icon">üí¨</span>
          <span class="nav-label">Forum</span>
        </div>
        <div class="nav-item" onclick="showChatView()" id="navChat">
          <span class="nav-icon">‚úâÔ∏è</span>
          <span class="nav-label">Messages</span>
          <span class="unread-badge" id="chatUnreadBadge" style="display: none;">0</span>
        </div>
      </nav>

      <nav class="category-nav" id="forumCategoriesNav">
        <h3>Forum Categories</h3>
        <div id="categoryList"></div>
      </nav>

      <div class="sidebar-footer">
        <button class="logout-btn-sidebar" onclick="logout()">Logout</button>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="forum-main">
      <!-- Category View -->
      <div id="categoryView" class="visible">
        <div class="forum-header">
          <div class="forum-header-content">
            <h1 id="categoryTitle">
              <span id="categoryIcon">üí¨</span>
              <span id="categoryName">Select a Category</span>
            </h1>
            <p id="categoryDescription">Choose a category from the sidebar to view threads</p>
          </div>
          <button
class="btn-new-thread"
id="btnNewThread"
onclick="showNewThreadForm()"
>
            <span>‚úèÔ∏è</span>
            <span>New Thread</span>
          </button>
        </div>

        <div id="threadList" class="thread-list"></div>
      </div>

      <!-- Thread View -->
      <div id="threadView" class="hidden">
        <button class="back-button" onclick="showCategoryView()">
          <span>‚Üê</span>
          <span>Back to Threads</span>
        </button>

        <div class="thread-view">
          <div class="thread-view-header">
            <h2 class="thread-view-title" id="threadTitle"></h2>
            <div class="thread-view-meta">
              <div class="thread-view-author">
                <div class="author-avatar" id="threadAuthorAvatar">A</div>
                <div class="author-details">
                  <span class="author-name" id="threadAuthorName"></span>
                  <span class="post-date" id="threadDate"></span>
                </div>
              </div>
              <div class="thread-stats">
                <span class="stat-item">
                  <span>üëÅÔ∏è</span>
                  <span id="threadViews">0</span> views
                </span>
                <span class="stat-item">
                  <span>üí¨</span>
                  <span id="threadReplies">0</span> replies
                </span>
              </div>
            </div>
          </div>
          <div class="thread-view-content" id="threadContent"></div>
        </div>

        <div class="posts-section">
          <h2>Replies</h2>
          <div id="postsList"></div>
        </div>

        <div class="reply-form">
          <h3>Post a Reply</h3>
          <form id="replyForm" onsubmit="submitReply(event)">
            <div class="form-group">
              <label class="form-label" for="replyContent">Your Reply</label>
              <textarea 
                class="form-textarea" 
                id="replyContent" 
                name="replyContent" 
                rows="5" 
                placeholder="Share your thoughts..."
                required
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label" for="replyPhotos">Attach Photos (Optional)</label>
              <input 
                type="file" 
                class="form-input" 
                id="replyPhotos" 
                name="replyPhotos" 
                accept="image/*"
                multiple
              >
              <p class="form-help-text">You can upload up to 5 photos (max 5MB each)</p>
              <div id="replyPhotosPreview" class="photos-preview"></div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-submit">Post Reply</button>
            </div>
          </form>
        </div>
      </div>

      <!-- New Thread Form -->
      <div id="newThreadView" class="hidden">
        <button class="back-button" onclick="showCategoryView()">
          <span>‚Üê</span>
          <span>Back to Threads</span>
        </button>

        <div class="new-thread-form">
          <h2>Create New Thread</h2>
          <form id="newThreadForm" onsubmit="submitNewThread(event)">
            <div class="form-group">
              <label class="form-label" for="threadTitle">Thread Title</label>
              <input 
                type="text" 
                class="form-input" 
                id="newThreadTitle" 
                name="threadTitle" 
                placeholder="Enter a descriptive title..."
                required
                maxlength="200"
              >
            </div>
            <div class="form-group">
              <label class="form-label" for="threadContent">Content</label>
              <textarea 
                class="form-textarea" 
                id="newThreadContent" 
                name="threadContent" 
                rows="10" 
                placeholder="Share your thoughts, questions, or information..."
                required
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label" for="threadPhotos">Attach Photos (Optional)</label>
              <input 
                type="file" 
                class="form-input" 
                id="threadPhotos" 
                name="threadPhotos" 
                accept="image/*"
                multiple
              >
              <p class="form-help-text">You can upload up to 5 photos (max 5MB each)</p>
              <div id="threadPhotosPreview" class="photos-preview"></div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-submit">Create Thread</button>
              <button
type="button"
class="btn-cancel"
onclick="showCategoryView()"
>Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Chat View -->
      <div id="chatView" class="hidden">
        <div class="chat-container">
          <!-- Chat Sidebar - Conversations List -->
          <div class="chat-sidebar">
            <div class="chat-sidebar-header">
              <h2>Messages</h2>
              <button class="new-chat-btn" id="newChatBtn">+ New Chat</button>
            </div>
            <div class="conversations-list" id="conversationsList">
              <!-- Conversations will be loaded here -->
            </div>
          </div>

          <!-- Chat Main Area -->
          <div class="chat-main" id="chatMain" style="display: none;">
            <div class="chat-header">
              <div class="chat-header-avatar" id="chatHeaderAvatar">U</div>
              <div class="chat-header-info">
                <h3 id="chatHeaderName">User</h3>
                <div class="chat-header-username" id="chatHeaderUsername">@username</div>
              </div>
            </div>

            <div class="chat-messages" id="chatMessages">
              <!-- Messages will be loaded here -->
            </div>

            <div class="chat-input-area">
              <form class="chat-input-form" id="chatForm">
                <input 
                  type="text" 
                  class="chat-input" 
                  id="chatInput" 
                  placeholder="Type a message..."
                  autocomplete="off"
                  required
                >
                <button type="submit" class="chat-send-btn" id="chatSendBtn">
                  <span>Send</span>
                  <span>üì§</span>
                </button>
              </form>
            </div>
          </div>

          <!-- Empty State -->
          <div class="chat-empty-state" id="chatEmptyState">
            <div class="chat-empty-state-icon">üí¨</div>
            <h3>No conversation selected</h3>
            <p>Choose a conversation from the list or start a new chat</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- User Search Modal -->
  <div class="user-search-modal" id="userSearchModal">
    <div class="user-search-content">
      <div class="user-search-header">
        <h3>Start a New Chat</h3>
        <button class="close-modal-btn" id="closeModalBtn">√ó</button>
      </div>
      <input 
        type="text" 
        class="user-search-input" 
        id="userSearchInput" 
        placeholder="Search users by username..."
        autocomplete="off"
      >
      <div class="user-search-results" id="userSearchResults">
        <!-- Search results will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="./js/storage.js"></script>
  <script src="./js/forum.js"></script>
  <script src="./js/upload.js"></script>
  <script src="./js/chat.js"></script>
  <script>
    // Global state
    let currentUser = null;
    let currentCategory = null;
    let currentThread = null;
    let threadPhotos = [];
    let replyPhotos = [];

    // Initialize application
    function init() {
      // Check if user is logged in
      currentUser = Storage.getCurrentUser();
      
      if (!currentUser) {
        window.location.href = './index.html';
        return;
      }

      // Display user information
      displayUserInfo();
      
      // Load categories
      loadCategories();

      // Setup mobile menu
      setupMobileMenu();

      // Initialize photo upload handlers
      initializePhotoUploads();

      // Load first category by default
      const categories = Forum.getCategories();
      if (categories.length > 0) {
        selectCategory(categories[0].id);
      }
      
      // Set forum as default active view
      document.getElementById('navForum').classList.add('active');
      
      // Update unread count periodically
      setInterval(updateUnreadCount, 5000);
    }

    // Initialize photo upload handlers
    function initializePhotoUploads() {
      // Thread photos
      const threadPhotosInput = document.getElementById('threadPhotos');
      const threadPhotosPreview = document.getElementById('threadPhotosPreview');
      if (threadPhotosInput && threadPhotosPreview) {
        PhotoUpload.initializeFileInput(
          threadPhotosInput,
          threadPhotosPreview,
          threadPhotos,
          (photos) => {
            threadPhotos = photos;
          }
        );
      }

      // Reply photos
      const replyPhotosInput = document.getElementById('replyPhotos');
      const replyPhotosPreview = document.getElementById('replyPhotosPreview');
      if (replyPhotosInput && replyPhotosPreview) {
        PhotoUpload.initializeFileInput(
          replyPhotosInput,
          replyPhotosPreview,
          replyPhotos,
          (photos) => {
            replyPhotos = photos;
          }
        );
      }
    }

    // Display user information
    function displayUserInfo() {
      const userName = currentUser.name;
      const username = currentUser.username || 'user';
      const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
      
      document.getElementById('sidebarUserName').textContent = userName;
      document.getElementById('sidebarUsername').textContent = '@' + username;
      document.getElementById('sidebarAvatar').textContent = initials;
      
      // Update unread message count
      updateUnreadCount();
    }

    // Load categories into sidebar
    function loadCategories() {
      const categories = Forum.getCategories();
      const categoryList = document.getElementById('categoryList');
      
      categoryList.innerHTML = categories.map(category => `
        <div class="category-item" data-category-id="${category.id}" onclick="selectCategory('${category.id}')">
          <span class="category-icon">${category.icon}</span>
          <div class="category-info">
            <div class="category-name">${category.name}</div>
            <div class="category-description">${category.description}</div>
          </div>
        </div>
      `).join('');
    }

    // Select category
    function selectCategory(categoryId) {
      currentCategory = categoryId;
      
      // Update active state in sidebar
      document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-category-id="${categoryId}"]`)?.classList.add('active');
      
      // Load category data
      const category = Forum.getCategoryById(categoryId);
      if (category) {
        document.getElementById('categoryIcon').textContent = category.icon;
        document.getElementById('categoryName').textContent = category.name;
        document.getElementById('categoryDescription').textContent = category.description;
      }
      
      // Load threads for this category
      loadThreads(categoryId);
      
      // Show category view
      showCategoryView();

      // Close mobile menu if open
      closeMobileMenu();
    }

    // Load threads for category
    function loadThreads(categoryId) {
      const threads = Forum.getThreadsByCategory(categoryId);
      const threadList = document.getElementById('threadList');
      
      if (threads.length === 0) {
        threadList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <h3>No threads yet</h3>
            <p>Be the first to start a conversation in this category!</p>
            <button class="btn-primary" onclick="showNewThreadForm()">Create First Thread</button>
          </div>
        `;
        return;
      }
      
      threadList.innerHTML = threads.map(thread => {
        const authorInitials = thread.authorName.split(' ').map(n => n[0]).join('').toUpperCase();
        return `
          <div class="thread-card" onclick="viewThread('${thread.id}')">
            <div class="thread-card-header">
              <h3 class="thread-title">${escapeHtml(thread.title)}</h3>
            </div>
            <p class="thread-content-preview">${escapeHtml(thread.content)}</p>
            <div class="thread-footer">
              <div class="thread-author">
                <div class="author-avatar-small">${authorInitials}</div>
                <span>${escapeHtml(thread.authorName)}</span>
              </div>
              <div class="thread-stats">
                <span class="stat-item">
                  <span>üëÅÔ∏è</span>
                  <span>${thread.views}</span>
                </span>
                <span class="stat-item">
                  <span>üí¨</span>
                  <span>${thread.replyCount}</span>
                </span>
                <span class="stat-item">
                  <span>üïí</span>
                  <span>${Forum.formatDate(thread.updatedAt)}</span>
                </span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // View thread
    function viewThread(threadId) {
      const thread = Forum.getThreadById(threadId);
      if (!thread) return;
      
      currentThread = thread;
      
      // Increment view count
      Forum.incrementThreadViews(threadId);
      
      // Display thread details
      const authorInitials = thread.authorName.split(' ').map(n => n[0]).join('').toUpperCase();
      document.getElementById('threadTitle').textContent = thread.title;
      document.getElementById('threadAuthorAvatar').textContent = authorInitials;
      document.getElementById('threadAuthorName').textContent = thread.authorName;
      document.getElementById('threadDate').textContent = Forum.formatDate(thread.createdAt);
      document.getElementById('threadViews').textContent = thread.views + 1;
      document.getElementById('threadReplies').textContent = thread.replyCount;
      
      // Display thread content
      const threadContentDiv = document.getElementById('threadContent');
      threadContentDiv.textContent = thread.content;
      
      // Display thread photos if any
      if (thread.photos && thread.photos.length > 0) {
        const photoGallery = PhotoUpload.createPhotoGallery(thread.photos);
        if (photoGallery) {
          threadContentDiv.appendChild(photoGallery);
        }
      }
      
      // Load posts
      loadPosts(threadId);
      
      // Show thread view
      document.getElementById('categoryView').classList.add('hidden');
      document.getElementById('newThreadView').classList.add('hidden');
      document.getElementById('threadView').classList.remove('hidden');
      
      // Scroll to top
      window.scrollTo(0, 0);
    }

    // Load posts for thread
    function loadPosts(threadId) {
      const posts = Forum.getPostsByThread(threadId);
      const postsList = document.getElementById('postsList');
      
      if (posts.length === 0) {
        postsList.innerHTML = `
          <div class="empty-state">
            <p>No replies yet. Be the first to reply!</p>
          </div>
        `;
        return;
      }
      
      // Organize posts by parent
      const topLevelPosts = posts.filter(post => !post.parentPostId);
      
      postsList.innerHTML = topLevelPosts.map(post => {
        const replies = Forum.getRepliesByPost(post.id);
        return renderPost(post) + replies.map(reply => renderPost(reply, true)).join('');
      }).join('');
    }

    // Render single post
    function renderPost(post, isReply = false) {
      const authorInitials = post.authorName.split(' ').map(n => n[0]).join('').toUpperCase();
      const replyClass = isReply ? 'reply' : '';
      
      let photosHtml = '';
      if (post.photos && post.photos.length > 0) {
        photosHtml = '<div class="post-photos">';
        post.photos.forEach((photo, index) => {
          photosHtml += `
            <img 
              src="${photo.base64}" 
              alt="${photo.filename || 'Photo ' + (index + 1)}" 
              class="post-photo"
              onclick="PhotoUpload.showFullSizeImage(${JSON.stringify(photo).replace(/"/g, '&quot;')})"
              style="cursor: pointer; max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 8px; margin: 8px 8px 0 0; border: 2px solid #FFE4E9;"
            >
          `;
        });
        photosHtml += '</div>';
      }
      
      return `
        <div class="post-item ${replyClass}">
          <div class="post-header">
            <div class="author-avatar-small">${authorInitials}</div>
            <div class="author-details">
              <span class="author-name">${escapeHtml(post.authorName)}</span>
              <span class="post-date">${Forum.formatDate(post.createdAt)}</span>
            </div>
          </div>
          <div class="post-content">${escapeHtml(post.content)}</div>
          ${photosHtml}
        </div>
      `;
    }

    // Submit reply
    function submitReply(event) {
      event.preventDefault();
      
      const content = document.getElementById('replyContent').value.trim();
      if (!content || !currentThread) return;
      
      const post = Forum.createPost({
        threadId: currentThread.id,
        content: content,
        photos: replyPhotos,
        parentPostId: null
      });
      
      if (post) {
        // Clear form
        document.getElementById('replyContent').value = '';
        document.getElementById('replyPhotosPreview').innerHTML = '';
        replyPhotos = [];
        
        // Reload thread to show new reply
        viewThread(currentThread.id);
        
        // Show success message
        showNotification('Reply posted successfully!');
      } else {
        showNotification('Failed to post reply. Please try again.', 'error');
      }
    }

    // Show new thread form
    function showNewThreadForm() {
      if (!currentCategory) {
        showNotification('Please select a category first.', 'error');
        return;
      }
      
      document.getElementById('categoryView').classList.add('hidden');
      document.getElementById('threadView').classList.add('hidden');
      document.getElementById('newThreadView').classList.remove('hidden');
      
      // Clear form
      document.getElementById('newThreadTitle').value = '';
      document.getElementById('newThreadContent').value = '';
      document.getElementById('threadPhotosPreview').innerHTML = '';
      threadPhotos = [];
      
      // Scroll to top
      window.scrollTo(0, 0);
    }

    // Submit new thread
    function submitNewThread(event) {
      event.preventDefault();
      
      const title = document.getElementById('newThreadTitle').value.trim();
      const content = document.getElementById('newThreadContent').value.trim();
      
      if (!title || !content || !currentCategory) return;
      
      const thread = Forum.createThread({
        categoryId: currentCategory,
        title: title,
        content: content,
        photos: threadPhotos
      });
      
      if (thread) {
        // Clear form
        document.getElementById('newThreadTitle').value = '';
        document.getElementById('newThreadContent').value = '';
        document.getElementById('threadPhotosPreview').innerHTML = '';
        threadPhotos = [];
        
        // Reload threads
        loadThreads(currentCategory);
        
        // Show category view
        showCategoryView();
        
        // Show success message
        showNotification('Thread created successfully!');
      } else {
        showNotification('Failed to create thread. Please try again.', 'error');
      }
    }

    // Show category view
    function showCategoryView() {
      document.getElementById('categoryView').classList.remove('hidden');
      document.getElementById('threadView').classList.add('hidden');
      document.getElementById('newThreadView').classList.add('hidden');
      
      // Reload threads if category is selected
      if (currentCategory) {
        loadThreads(currentCategory);
      }
      
      // Scroll to top
      window.scrollTo(0, 0);
    }

    // Setup mobile menu
    function setupMobileMenu() {
      const toggle = document.getElementById('mobileMenuToggle');
      const overlay = document.getElementById('mobileMenuOverlay');
      const sidebar = document.getElementById('forumSidebar');
      
      toggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
      });
      
      overlay.addEventListener('click', closeMobileMenu);
    }

    // Close mobile menu
    function closeMobileMenu() {
      document.getElementById('forumSidebar').classList.remove('active');
      document.getElementById('mobileMenuOverlay').classList.remove('active');
    }

    // Show notification
    function showNotification(message, type = 'success') {
      const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert ${alertClass}`;
      alertDiv.textContent = message;
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '1000';
      alertDiv.style.minWidth = '250px';
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Show forum view
    function showForumView() {
      document.getElementById('categoryView').classList.remove('hidden');
      document.getElementById('threadView').classList.add('hidden');
      document.getElementById('newThreadView').classList.add('hidden');
      document.getElementById('chatView').classList.add('hidden');
      document.getElementById('forumCategoriesNav').style.display = 'block';
      
      // Update navigation active state
      document.getElementById('navForum').classList.add('active');
      document.getElementById('navChat').classList.remove('active');
      
      // Reload threads if category is selected
      if (currentCategory) {
        loadThreads(currentCategory);
      }
    }

    // Show chat view
    function showChatView() {
      document.getElementById('categoryView').classList.add('hidden');
      document.getElementById('threadView').classList.add('hidden');
      document.getElementById('newThreadView').classList.add('hidden');
      document.getElementById('chatView').classList.remove('hidden');
      document.getElementById('forumCategoriesNav').style.display = 'none';
      
      // Update navigation active state
      document.getElementById('navForum').classList.remove('active');
      document.getElementById('navChat').classList.add('active');
      
      // Initialize chat if not already done
      if (typeof Chat !== 'undefined' && Chat.init) {
        Chat.init();
      }
      
      // Close mobile menu if open
      closeMobileMenu();
    }

    // Update unread message count
    function updateUnreadCount() {
      if (!currentUser) return;
      
      const unreadCount = Storage.getUnreadCount(currentUser.id);
      const badge = document.getElementById('chatUnreadBadge');
      
      if (badge) {
        if (unreadCount > 0) {
          badge.textContent = unreadCount;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    // Logout function
    function logout() {
      Storage.logout();
      window.location.href = './index.html';
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
